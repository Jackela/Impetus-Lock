name: E2E Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or commit to run E2E tests on'
        required: false
        default: 'main'

jobs:
  e2e:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: impetus_lock_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-noble
      options: --user 1001
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          python -m pip install poetry
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('server/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: Install backend dependencies
        working-directory: ./server
        run: poetry install

      - name: Start backend server
        env:
          TESTING: "true"
          DATABASE_URL: postgresql://postgres:postgres@postgres:5432/impetus_lock_test
        shell: bash
        run: |
          cd server && poetry run uvicorn server.main:app --host 0.0.0.0 --port 8000 &
          BACKEND_PID=$!
          echo "Backend PID: $BACKEND_PID"
          echo "Waiting for backend to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:8000/health > /dev/null 2>&1; then
              echo "‚úÖ Backend is ready!"
              break
            fi
            if ! ps -p $BACKEND_PID > /dev/null 2>&1; then
              echo "‚ùå Backend process died! Last logs:"
              tail -20 /tmp/backend.log
              exit 1
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          curl -f http://localhost:8000/health || (echo "‚ùå Backend failed to start. Logs:" && tail -20 /tmp/backend.log && exit 1)

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Verify Playwright version compatibility
        working-directory: ./client
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').devDependencies['@playwright/test']" | sed 's/[^0-9.]//g')
          INSTALLED_VERSION=$(npx playwright --version | grep -oP '\d+\.\d+\.\d+' | head -1)
          echo "üì¶ package.json version: $PACKAGE_VERSION"
          echo "üê≥ Docker image version: $INSTALLED_VERSION"
          if [ "$PACKAGE_VERSION" != "$INSTALLED_VERSION" ]; then
            echo "‚ùå Version mismatch detected!"
            echo "Please update .github/workflows/e2e.yml Docker image to: mcr.microsoft.com/playwright:v${PACKAGE_VERSION}-noble"
            exit 1
          fi
          echo "‚úÖ Versions match!"

      - name: Run Playwright E2E tests
        working-directory: ./client
        run: npm run test:e2e

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: client/playwright-report/
          retention-days: 30
