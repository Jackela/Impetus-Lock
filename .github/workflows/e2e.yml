name: E2E Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  e2e:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-noble
      options: --user 1001
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        working-directory: ./client
        run: npm ci

      - name: Verify Playwright version compatibility
        working-directory: ./client
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').devDependencies['@playwright/test']" | sed 's/[^0-9.]//g')
          INSTALLED_VERSION=$(npx playwright --version | grep -oP '\d+\.\d+\.\d+' | head -1)
          echo "üì¶ package.json version: $PACKAGE_VERSION"
          echo "üê≥ Docker image version: $INSTALLED_VERSION"
          if [ "$PACKAGE_VERSION" != "$INSTALLED_VERSION" ]; then
            echo "‚ùå Version mismatch detected!"
            echo "Please update .github/workflows/e2e.yml Docker image to: mcr.microsoft.com/playwright:v${PACKAGE_VERSION}-noble"
            exit 1
          fi
          echo "‚úÖ Versions match!"

      - name: Run Playwright E2E tests
        working-directory: ./client
        run: npm run test:e2e

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report
          path: client/playwright-report/
          retention-days: 30
