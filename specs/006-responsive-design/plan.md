# Implementation Plan: Responsive Design (响应式设计)

**Branch**: `006-responsive-design` | **Date**: 2025-11-09 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/006-responsive-design/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Adapt the Impetus Lock application's UI/UX for mobile and tablet devices through responsive design patterns. This feature ensures the P1-P4 "Zen mode" and "gamified discipline" vibe translates seamlessly across all form factors (mobile phones 375px-767px, tablets 768px-1023px, desktop ≥1024px) without horizontal scrolling or content overflow. Implementation focuses on CSS-only responsive layouts (media queries, flexbox/grid, viewport units) with conditional component rendering for mobile-specific UI patterns (bottom-docked toolbar, compact controls). No new data models or API endpoints required—purely frontend presentation layer enhancements.

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode), React 19.1.1 (client-side only)
**Primary Dependencies**:
- React 19.1.1 + React DOM 19.1.1 (UI framework)
- Vite 6.x (build tool with HMR)
- Framer Motion 12.x (animations - must scale for mobile viewports)
- Milkdown 7.17.1 (WYSIWYG editor - must adapt to narrow viewports)
- Floating UI (from P4 FloatingToolbar - requires responsive positioning strategies)
- @testing-library/react 16.x (component testing)
- Playwright 1.56.1 (E2E responsive testing)

**Storage**: N/A (no data persistence changes - purely UI/CSS)
**Testing**:
- Vitest (unit/integration tests for responsive component behavior)
- Playwright (E2E tests for viewport-specific layouts)
- Chrome DevTools responsive mode (manual testing)

**Target Platform**: Web browsers (modern mobile/tablet/desktop)
- Mobile: iOS Safari 12+, Chrome for Android 80+, Samsung Internet 10+
- Tablet/Desktop: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

**Project Type**: Web application (frontend-only changes to existing React SPA)

**Performance Goals**:
- Lighthouse mobile score ≥85 (Performance), ≥90 (Accessibility)
- Layout shift (CLS) ≤0.1 during breakpoint transitions
- No visual glitches during orientation changes (portrait ↔ landscape)
- Touch target hit testing 100% compliant (44x44px minimum)

**Constraints**:
- Must support minimum viewport width 320px (iPhone SE portrait)
- No horizontal scrolling at any viewport width (320px-∞)
- CSS-only implementation preferred (minimize JavaScript-based layout logic)
- Preserve all P1-P4 functionality (locked content, AI intervention, sensory feedback, markdown toolbar)
- WCAG 2.1 AA compliance (touch targets, color contrast, semantic HTML)

**Scale/Scope**:
- ~10 React components require responsive adaptations (App, EditorCore, FloatingToolbar, AIIntervention controls)
- 3 breakpoint tiers (mobile <768px, tablet 768-1023px, desktop ≥1024px)
- 4 user stories (US1-US4 all P2/P3 priority)
- Estimated 50-100 lines of responsive CSS + 20-30 lines of conditional rendering logic

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Article I: Simplicity & Anti-Abstraction

- [x] **Framework-native features prioritized over custom implementations**
  - ✅ Using CSS media queries (native browser feature) for breakpoints
  - ✅ Using CSS flexbox/grid (native) for fluid layouts instead of CSS-in-JS abstractions
  - ✅ Using React's `window.matchMedia` hook (or lightweight hook wrapper) instead of heavy responsive libraries

- [x] **Simplest viable implementation path chosen**
  - ✅ CSS-only approach preferred (media queries in `.css` files)
  - ✅ Conditional rendering only where necessary (e.g., toolbar positioning mode)
  - ✅ No CSS framework (Bootstrap/Tailwind) needed - custom media queries are simpler for 3 breakpoints

- [x] **No unnecessary wrapper classes or abstraction layers**
  - ✅ No custom "ResponsiveContainer" wrapper components
  - ✅ No abstraction over media queries (use raw CSS `@media` directly)
  - ✅ Exception: One lightweight `useMediaQuery` hook acceptable for conditional rendering (standard pattern, <10 lines)

- [x] **Any abstractions justified by actual (not anticipated) multi-implementation scenarios**
  - ✅ `useMediaQuery` hook: Needed to conditionally render bottom-docked vs. floating toolbar (cannot be done with CSS alone)
  - ✅ CSS custom properties for breakpoint values: Justified for DRY principle (breakpoints used in multiple files)

**PASS** - No violations. Responsive design is inherently simple (CSS media queries) with minimal abstraction.

---

### Article II: Vibe-First Imperative

- [x] **Un-deletable constraint is P1 priority (only this feature is P1)**
  - ✅ This feature (Responsive Design) does NOT claim P1 priority
  - ✅ All user stories correctly marked P2 (US1 Adaptive Layout) or P3 (US2 Toolbar, US3 Typography, US4 AI Controls)

- [x] **All other features (UI polish, auxiliary functions) marked P2 or lower**
  - ✅ US1 (P2): Foundational mobile accessibility - essential but not core "vibe"
  - ✅ US2-US4 (P3): Polish and refinement - enhances mobile UX but not critical

- [x] **P1 tasks scheduled for wave 1 implementation**
  - ✅ N/A - This feature has no P1 tasks (correctly)

- [x] **P1 tasks represent ≥60% of story points**
  - ✅ N/A - This feature is a P5 polish feature, not a P1 vibe feature

**PASS** - Correct priority alignment. Responsive design is explicitly scoped as polish (P2/P3), not core vibe (P1).

---

### Article III: Test-First Imperative (NON-NEGOTIABLE)

- [x] **Test tasks created for ALL P1 user stories BEFORE implementation tasks**
  - ✅ N/A - No P1 user stories in this feature

- [x] **TDD workflow enforced: failing test → verify failure → minimal implementation → refactor**
  - ✅ Will follow for responsive component tests:
    1. Write failing Vitest test for viewport-specific rendering (e.g., toolbar docked at <768px)
    2. Verify test fails (component not yet responsive)
    3. Add CSS media query or conditional render to pass test
    4. Refactor CSS for clarity

- [x] **Test coverage ≥80% for critical paths (un-deletable logic, lock enforcement)**
  - ✅ Responsive design is presentation layer - target 80% coverage for:
    - Conditional rendering logic (toolbar mode selection based on viewport)
    - Touch target size validation (WCAG compliance)
    - Layout reflow edge cases (long content, virtual keyboard)
  - ⚠️ Note: Pure CSS media queries not directly testable in Vitest - use Playwright E2E for viewport-specific layouts

- [x] **P1 features have corresponding test files**
  - ✅ N/A - No P1 features in this scope

**PASS** - TDD workflow will be followed for responsive component logic. Playwright E2E tests will validate CSS breakpoints.

---

### Article IV: SOLID Principles

- [x] **SRP: FastAPI endpoints delegate business logic to service layer classes**
  - ✅ N/A - This is a frontend-only feature (no backend endpoints)

- [x] **DIP: High-level logic depends on abstractions (protocols/interfaces), not concrete implementations**
  - ✅ Applied to frontend: Toolbar component will depend on viewport width abstraction (via `useMediaQuery` hook), not direct `window.innerWidth` access
  - ✅ Sensory feedback animations (Framer Motion) already abstracted - just need to scale `x`/`y` values for mobile

- [x] **No endpoint handlers contain raw SQL or business rules**
  - ✅ N/A - No backend changes

- [x] **Service classes use constructor injection (no direct instantiation of infrastructure dependencies)**
  - ✅ Applied to frontend: React components will receive viewport state via props/hooks (not direct DOM queries)

**PASS** - SOLID principles adapted for frontend context. Component separation and abstraction appropriate.

---

### Article V: Clear Comments & Documentation

- [x] **Frontend: JSDoc comments for all exported functions/components**
  - ✅ Will document:
    - `useMediaQuery` hook (if created): Explain parameters, return value, usage example
    - Responsive component variants (e.g., `ToolbarMobile`, `ToolbarDesktop`): Explain breakpoint behavior
    - CSS custom properties: Document breakpoint values in CSS file comments

- [x] **Backend: Python docstrings (Google/NumPy style) for all public functions/classes**
  - ✅ N/A - No backend changes

- [x] **Documentation present for all public interfaces**
  - ✅ Will add JSDoc to any new hooks or utility functions
  - ✅ CSS comments for media query breakpoints and magic numbers

- [x] **Missing documentation flagged as blocking if on critical path**
  - ✅ Will lint with ESLint + jsdoc plugin (already configured in project)

**PASS** - Documentation standards will be maintained for new responsive code.

---

## Project Structure

### Documentation (this feature)

```text
specs/006-responsive-design/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0: Best practices for responsive design, Milkdown responsiveness, Floating UI
├── quickstart.md        # Phase 1: Manual testing guide for responsive layouts
├── checklists/
│   └── requirements.md  # Spec quality validation (already complete)
└── spec.md              # Feature specification (already complete)
```

**Note**: No `data-model.md` or `contracts/` needed - this is a CSS/UI-only feature with no data or API changes.

### Source Code (repository root)

```text
client/                          # Frontend (React + Vite + TypeScript)
├── src/
│   ├── components/
│   │   ├── App.tsx              # [MODIFY] Add responsive layout wrapper
│   │   ├── Editor/
│   │   │   ├── EditorCore.tsx   # [MODIFY] Responsive editor container styles
│   │   │   └── FloatingToolbar.tsx  # [MODIFY] Conditional toolbar positioning (bottom-docked <768px)
│   │   └── AIIntervention/
│   │       ├── ModeSelector.tsx # [MODIFY] Compact dropdown layout for mobile
│   │       └── ProvokeButton.tsx # [MODIFY] Ensure 44x44px touch target
│   ├── hooks/
│   │   └── useMediaQuery.ts     # [NEW] Lightweight hook for breakpoint detection
│   ├── styles/
│   │   ├── responsive.css       # [NEW] Global responsive utilities (breakpoints, typography scales)
│   │   └── variables.css        # [MODIFY] Add CSS custom properties for breakpoints
│   └── utils/
│       └── animation-scaling.ts # [NEW] Scale Framer Motion animation values for mobile
├── e2e/
│   └── responsive.spec.ts       # [NEW] Playwright tests for viewport-specific layouts
└── index.html                   # [MODIFY] Update viewport meta tag

tests/ (Vitest unit tests)
├── components/
│   ├── FloatingToolbar.test.tsx # [MODIFY] Add responsive positioning tests
│   └── AIIntervention.test.tsx  # [MODIFY] Add mobile layout tests
└── hooks/
    └── useMediaQuery.test.ts    # [NEW] Test breakpoint detection logic
```

**Structure Decision**: Existing React SPA structure (client/) is sufficient. No new directories needed. Responsive logic will be co-located with existing components, with shared responsive utilities in `src/hooks/` and `src/styles/`.

---

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | N/A | No violations - all constitutional gates pass |

---

## Phase 0: Research & Best Practices

**Output**: `research.md` documenting:

1. **Responsive Design Patterns for React 19**
   - Research Task: Find best practices for responsive layouts in React 19 (functional components, hooks-based)
   - Focus: CSS-first vs. JS-first approaches, performance implications, SSR considerations (not applicable here but worth noting)
   - Deliverable: Decision on CSS media queries vs. `window.matchMedia` API + hook pattern

2. **Milkdown Editor Responsiveness**
   - Research Task: Investigate how Milkdown 7.x handles narrow viewports
   - Focus: Does Milkdown have built-in responsive styles? Are there hardcoded widths to override?
   - Reference: Check Milkdown docs, GitHub issues, and existing CSS overrides in EditorCore.tsx
   - Deliverable: Strategy for making Milkdown editor adapt to <768px widths (CSS overrides needed?)

3. **Floating UI Responsive Positioning**
   - Research Task: Explore Floating UI library support for responsive positioning strategies
   - Focus: Can middleware (flip, shift) be configured conditionally based on viewport width? How to switch from floating to fixed positioning?
   - Reference: Floating UI docs on platform-specific configurations
   - Deliverable: Pattern for bottom-docked toolbar on mobile (<768px) while maintaining floating behavior on desktop

4. **WCAG Touch Target Compliance**
   - Research Task: Review WCAG 2.1 AA requirements for touch target sizing (44x44px minimum)
   - Focus: How to audit existing components? CSS techniques to enlarge hit areas without changing visual size?
   - Deliverable: Testing checklist + CSS pattern (e.g., `::before` pseudo-element for larger hit area)

5. **Framer Motion Mobile Performance**
   - Research Task: Best practices for scaling Framer Motion animations on mobile devices
   - Focus: Should animation values (translateX, rotate) scale proportionally to viewport? Performance impact on low-end mobile devices?
   - Deliverable: Animation scaling utility function or CSS approach

6. **Virtual Keyboard Handling**
   - Research Task: How to handle mobile virtual keyboard appearance without breaking layout
   - Focus: `window.visualViewport` API vs. CSS viewport units (vh vs. svh/dvh)
   - Deliverable: Strategy for preventing layout collapse when keyboard appears (e.g., toolbar fixed positioning)

**Completion Criteria**: All 6 research tasks documented in `research.md` with decisions, rationale, and code examples.

---

## Phase 1: Design & Implementation Strategy

**Prerequisites**: `research.md` complete

### A. No Data Model Changes

**Rationale**: This feature is purely presentational (CSS/UI layer). No new entities, no database changes, no state management beyond existing React state.

**Output**: `data-model.md` not needed - skip this artifact.

---

### B. No API Contract Changes

**Rationale**: Responsive design is client-side only. No new endpoints, no modified request/response schemas.

**Output**: `contracts/` not needed - skip this artifact.

---

### C. Quickstart Guide for Manual Testing

**Output**: `quickstart.md` documenting:

1. **Development Setup**
   ```bash
   cd client
   npm run dev
   # Open http://localhost:5173 in Chrome DevTools responsive mode
   ```

2. **Manual Test Cases by Breakpoint**
   - **Mobile (375px width - iPhone SE)**:
     - [ ] No horizontal scrollbar
     - [ ] Editor content wraps properly
     - [ ] Floating toolbar docked to bottom
     - [ ] AI mode selector is compact dropdown
     - [ ] All buttons ≥44x44px (use DevTools measure tool)

   - **Tablet (768px width - iPad portrait)**:
     - [ ] Layout switches to intermediate sizing
     - [ ] Toolbar floats above selection (not bottom-docked)
     - [ ] Typography scales between mobile and desktop

   - **Desktop (1024px+ width)**:
     - [ ] Original layout preserved
     - [ ] No regression in existing functionality

3. **Device Rotation Test**
   ```
   1. Open on mobile viewport (375px portrait)
   2. Rotate to landscape (667px)
   3. Verify layout transitions smoothly (mobile → tablet breakpoint)
   4. Check for visual glitches or content loss
   ```

4. **Virtual Keyboard Test (Real Device Required)**
   ```
   1. Open app on real iPhone/Android device
   2. Tap into editor to trigger virtual keyboard
   3. Verify toolbar remains visible (not hidden by keyboard)
   4. Verify locked content remains accessible
   ```

5. **Playwright E2E Automation**
   ```bash
   cd client
   npm run test:e2e -- responsive.spec.ts
   # Tests will run in multiple viewport sizes automatically
   ```

**Completion Criteria**: Quickstart guide enables any developer to manually validate responsive behavior in <10 minutes.

---

## Phase 2: Task Breakdown (via /speckit.tasks)

**Note**: Detailed task list will be generated by `/speckit.tasks` command. Below is a high-level preview:

### Wave 1: Foundation (P2 - US1 Adaptive Layout)
- T001: Add viewport meta tag to `index.html` ✓ (TDD: verify meta tag exists)
- T002: Create CSS custom properties for breakpoints (768px, 1024px) ✓
- T003: Create `useMediaQuery` hook with tests ✓ (TDD: test hook returns correct boolean for viewport width)
- T004: Add responsive container styles to App.tsx ✓ (TDD: verify no horizontal scroll at 320px)
- T005: Make EditorCore responsive (flexbox, max-width 100%) ✓

### Wave 2: Toolbar & Controls (P3 - US2, US4)
- T006: Modify FloatingToolbar for bottom-docked mode on mobile ✓ (TDD: verify toolbar position:fixed bottom:0 at <768px)
- T007: Create compact ModeSelector dropdown for mobile ✓
- T008: Ensure ProvokeButton meets 44x44px touch target ✓ (TDD: measure button dimensions)

### Wave 3: Typography & Animations (P3 - US3, US4)
- T009: Add responsive typography scale in responsive.css ✓ (TDD: verify font-size changes at breakpoints)
- T010: Scale Framer Motion animations for mobile viewports ✓
- T011: Test sensory feedback (Glitch, Shake) on mobile ✓

### Wave 4: Testing & Validation
- T012: Write Playwright E2E tests for all breakpoints ✓
- T013: Lighthouse mobile audit (target: Performance ≥85, Accessibility ≥90) ✓
- T014: Manual testing on real devices (iPhone, Android, iPad) ✓

**Estimated Total**: 14 tasks, ~2-3 days implementation (assuming P1-P4 features are stable)

---

## Post-Design Constitution Re-Check

*Re-run after `quickstart.md` and research complete*

### Article I: Simplicity & Anti-Abstraction
- [x] **Post-Research Validation**:
  - ✅ CSS media queries confirmed as simplest approach (no JS library needed)
  - ✅ `useMediaQuery` hook pattern validated (React standard, <10 lines)
  - ✅ No over-engineering detected

### Article II: Vibe-First Imperative
- [x] **Priority Check**:
  - ✅ All tasks remain P2/P3 (no mission creep to P1)
  - ✅ Responsive design correctly scoped as polish, not core vibe

### Article III: Test-First Imperative
- [x] **Test Coverage Plan**:
  - ✅ Vitest tests for `useMediaQuery` hook (TDD)
  - ✅ Vitest tests for conditional rendering (toolbar mode, dropdown visibility)
  - ✅ Playwright E2E for visual regression at 3 breakpoints (320px, 768px, 1024px)
  - ✅ Manual WCAG touch target audit (44x44px compliance)

### Article IV: SOLID Principles
- [x] **Frontend Architecture**:
  - ✅ SRP: Responsive logic separated (useMediaQuery hook, responsive.css, component-specific styles)
  - ✅ DIP: Components depend on viewport abstraction (hook), not direct window access

### Article V: Clear Comments & Documentation
- [x] **Documentation Plan**:
  - ✅ JSDoc for `useMediaQuery` hook
  - ✅ CSS comments for media query breakpoints
  - ✅ Quickstart.md for testing workflow

**FINAL VERDICT**: ✅ **ALL GATES PASS** - Ready for `/speckit.tasks` phase.

---

## Next Steps

1. ✅ Complete `research.md` (Phase 0)
2. ✅ Complete `quickstart.md` (Phase 1)
3. ⏳ Run `/speckit.tasks` to generate detailed task breakdown
4. ⏳ Implement Wave 1 (Foundation) using TDD workflow
5. ⏳ Implement Waves 2-4 (Features + Testing)
6. ⏳ Manual validation on real devices
7. ⏳ Create PR with responsive design demo (screenshots/video)

---

**Plan Status**: ✅ **COMPLETE** - Ready for task generation
**Phase 0 Status**: ⏳ Pending - Generate `research.md` next
**Phase 1 Status**: ⏳ Pending - Generate `quickstart.md` after research
